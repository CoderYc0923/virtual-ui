var t=Object.defineProperty,e=(e,a,r)=>(((e,a,r)=>{a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[a]=r})(e,"symbol"!=typeof a?a+"":a,r),r);import{d as a,m as r,o,C as n,g as s,b as i,j as d,s as c,q as h,y as g,F as l,k as m,l as u}from"./vue-90884f3d.js";class p{static NoSupportMutation(t){return{code:1001,message:"Description enabling watermark protection failed",reason:t||"browsers do not support MutationObserver"}}static NoSupportCanvas(t){return{code:1002,message:"Failed to create watermark",reason:t||"browsers do not support canvas"}}static ImageNotFound(t){return{code:2001,message:"Image loading failed",reason:t||"may be an error image 'src'"}}static ParamsError(t){return{code:3001,message:"Parameter error",reason:t||"the parameter type or value is incorrect"}}static UnknownError(t){return{code:4001,message:"Unknown error",reason:t||"unknown reason"}}}const b=(t,e)=>{var a;const r={width:0,height:0},o=document.createElement("span");return r.width=o.offsetWidth,r.height=o.offsetWidth,o.style.visibility="hidden",o.style.fontSize=e+"px",document.body.appendChild(o),o.textContent?o.textContent=t:o.innerText=t,r.width=o.offsetWidth-r.width,r.height=o.offsetHeight-r.height,null==(a=o.parentNode)||a.removeChild(o),r},f=(t,e,a)=>{const r=new Image(e,a);return r.setAttribute("crossorigin","crossorigin"),r.src=t,new Promise(((t,e)=>{r.onload=()=>{t(r)},r.onerror=()=>{e(p.ImageNotFound())}}))};class w{constructor(t,a){e(this,"targetParent"),e(this,"targetClone"),e(this,"observer"),e(this,"_callback",(t=>{for(const e of t)"childList"===e.type?e.removedNodes.forEach((t=>{t===this.target&&(this.onchange&&this.onchange(e),this._readdDom())})):this.target===e.target&&(this.onchange&&this.onchange(e),this._readdDom())})),this.target=t,this.onchange=a,this.targetParent=this.target.parentElement,this.targetClone=t.cloneNode(!0)}start(){if(this.observer=new MutationObserver(this._callback),!this.observer)throw p.NoSupportMutation();this.observer.observe(this.targetParent,{characterData:!0,attributes:!0,childList:!0,subtree:!0})}stop(){this.observer.disconnect()}_readdDom(){const t=this.targetClone.cloneNode(!0);this.targetParent.appendChild(t),this.target=t,this.observer.disconnect(),this.start()}}class x{constructor(t,a){e(this,"watermakr",document.createElement("div")),e(this,"config"),e(this,"guardDom"),this.config=t,"image"===a?this.createImageWatermark():this.createTextWatermark()}remove(){var t,e;null==(t=this.guardDom)||t.stop(),null==(e=this.watermakr)||e.remove()}createImageWatermark(){const{image:t}=this.config;this._addWatermark2Container(t),this._observeWaterMark()}createTextWatermark(){const t=this.config,e=document.createElement("canvas"),{width:a}=b(t.text,t.fontSize),r=e.getContext("2d"),o=window.devicePixelRatio||1;if(e.width=(a+t.rowGap)*o,e.height=(a+t.colGap)*o,!r)throw p.NoSupportCanvas();r.font=`${t.fontSize}px Microsoft YaHei`,r.fillStyle=t.color,r.textAlign="center",r.textBaseline="middle",r.translate(e.width/2,e.height/2),r.rotate(Math.PI/180*t.angle),r.scale(o,o),r.fillText(t.text,0,0);const n=e.toDataURL();this._addWatermark2Container(n,e.width/o,e.height/o),this._observeWaterMark()}_addWatermark2Container(t,e,a){this.watermakr.className="vir-watermark";const r={"background-image":`url(${t})`,position:this.config.target===document.body?"fixed":"absolute",top:"0px",right:"0px",bottom:"0px",left:"0px","pointer-events":"none","background-repeat":"repeat","background-size":`${e}px ${a}px`,"z-index":this.config.zIndex,display:"block",visibility:"visible",width:"100%",height:"100%",opacity:"1"};let o="";for(let n in r)o+=`${n}: ${r[n]} !important; `;this.watermakr.setAttribute("style",o),this.config.target.style.position="relative",this.config.target.appendChild(this.watermakr)}_observeWaterMark(){var t;const{onchange:e,success:a}=this.config;this.guardDom=new w(this.watermakr,e),null==(t=this.guardDom)||t.start(),a&&a()}}class v{constructor(t,a){e(this,"config"),e(this,"canvas"),e(this,"image2canvas",(async()=>{const{image:t,position:e,target:a,success:r,imageWidth:o,imageHeight:n}=this.config,s=await f(t,o||30,n||30),{width:i,height:d}=s,{width:c,height:h}=this.canvas,g=this.canvas.getContext("2d");if(!g)throw p.NoSupportCanvas();{switch(e){case"center":g.drawImage(s,(c-i)/2,(h-d)/2,i,d);break;case"topLeft":g.drawImage(s,0,0,i,d);break;case"topRight":g.drawImage(s,c-i,0,i,d);break;case"bottomRight":g.drawImage(s,c-i,h-d,i,d);break;case"bottomLeft":g.drawImage(s,0,h-d,i,d);break;default:let t=0,e=0;for(;e<h;){for(;t<c;)g.drawImage(s,t,e,i,d),t+=i;t=0,e+=d}}const t=this.canvas.toDataURL();a.src=t,r&&r(t)}})),this.config=t,this.initTargetCanvas(),"image"===a?this.image2canvas():this.text2canvas()}initTargetCanvas(){const t=this.config.target,e=document.createElement("canvas"),{width:a,height:r}=t;e.width=a,e.height=r;const o=e.getContext("2d");if(!o)throw p.NoSupportCanvas();o.drawImage(t,0,0,a,r),this.canvas=e}text2canvas(){this.config.secret?this.drawEncryptedText2canvas():this.drawSurfaceText2canvas()}drawEncryptedText2canvas(){const{width:t,height:e}=this.canvas,a=this.canvas.getContext("2d");if(!a)throw p.NoSupportCanvas();{const r=a.getImageData(0,0,t,e),o=this._text2ImageData(this.config,t,e),n=this._encryptAndMergeImageData(r,o);a.putImageData(n,0,0);const s=this.canvas.toDataURL();this.config.target.src=s,this.config.success&&this.config.success(s)}}drawSurfaceText2canvas(){const t=this.config,{width:e,height:a}=this.canvas,r=this.canvas.getContext("2d");if(!r)throw p.NoSupportCanvas();{this._fillText2Ctx(r,t,e,a);const o=this.canvas.toDataURL();this.config.target.src=o,this.config.success&&this.config.success(o)}}_text2ImageData(t,e,a){let r=new ImageData(1,1);const o=document.createElement("canvas");o.width=e,o.height=a;const n=o.getContext("2d");if(!n)throw p.NoSupportCanvas();return this._fillText2Ctx(n,t,e,a),r=n.getImageData(0,0,e,a),r}_fillText2Ctx(t,e,a,r){let{position:o,color:n,fontSize:s,rowGap:i,colGap:d,angle:c,text:h}=e;switch(t.font=`${s}px microsoft yahei`,t.fillStyle=n,o){case"center":t.textAlign="center",t.textBaseline="middle",t.fillText(h,a/2,r/2);break;case"topLeft":t.textAlign="left",t.textBaseline="top",t.fillText(h,0+i,0+d);break;case"topRight":t.textAlign="right",t.textBaseline="top",t.fillText(h,a-i,0+d);break;case"bottomRight":t.textAlign="right",t.textBaseline="bottom",t.fillText(h,a-i,r-d);break;case"bottomLeft":t.textAlign="left",t.textBaseline="bottom",t.fillText(h,0+i,r-d);break;default:t.textAlign="center",t.textBaseline="middle";const{width:e}=b(h,s),o=e+i,n=e+d;t.translate(a/2,r/2),t.rotate(Math.PI/180*c);const g=Math.sqrt(Math.pow(a,2)+Math.pow(r,2));let l=-g/2,m=-g/2;for(;m<g/2;){for(;l<g/2;)t.fillText(h,l,m),l+=o;l=-g/2,m+=n}}}_encryptAndMergeImageData(t,e,a){const r=t.data,o=e.data;let n,s;switch(a){case"G":n=1,s=2;break;case"B":n=2,s=1;break;default:n=0,s=3}for(let i=0;i<r.length;i++)i%4===n&&(0===o[i+s]&&r[i]%2==1?255===r[i]?r[i]--:r[i]++:0!==o[i+s]&&r[i]%2==0&&r[i]++);return t}}const E=class t{constructor(){return t}static errorHandle(t,e){t.code?e.onerror&&e.onerror(t):e.onerror&&e.onerror(p.UnknownError(JSON.stringify(t)))}static async image(t){try{if(!t.target&&!t.image)throw p.ParamsError("the 'target' and 'image' parameters cannot be undefined at the same time.");if("string"==typeof t.target&&(t.target=await f(t.target)),t.image){const e={target:t.target,image:t.image,imageWidth:Number(t.imageWidth),imageHeight:Number(t.imageHeight),secret:t.secret||!1,position:t.position||"repeat",rowGap:Number(t.rowGap)||0,colGap:Number(t.colGap)||0,success:t.success,onerror:t.onerror};return new v(e,"image")}{const e={target:t.target,text:t.text||"VirWaterMark",secret:t.secret||!1,position:t.position||"repeat",color:t.color||"rgba(0, 0, 0, 1)",fontSize:Number(t.fontSize)||24,rowGap:Number(t.rowGap)||0,colGap:Number(t.colGap)||0,angle:Number(t.angle)||-25,success:t.success,onerror:t.onerror};return new v(e,"text")}}catch(e){this.errorHandle(e,t)}}static page(t={}){var e,a;try{if(t.image){const a={target:t.target||t.containerEl||document.body,image:t.image,zIndex:(null==(e=t.zIndex)?void 0:e.toString())||"1000",rowGap:Number(t.rowGap)||0,colGap:Number(t.colGap)||0,onchange:t.onchange,onerror:t.onerror,success:t.success};return new x(a,"image")}{const e={target:t.target||t.containerEl||document.body,text:t.text||"Demo Text",color:t.color||"rgba(0, 0, 0, 0.15)",fontSize:Number(t.fontSize)||24,zIndex:(null==(a=t.zIndex)?void 0:a.toLocaleString())||"10000",rowGap:Number(t.rowGap)||0,colGap:Number(t.colGap)||0,angle:Number(t.angle)||-25,onchange:t.onchange,onerror:t.onerror,success:t.success};return new x(e,"text")}}catch(r){this.errorHandle(r,t)}}};e(E,"utils",{encodeImage:async t=>{let e;return t.success=t=>e=t,await E.image(t),e},decodeImage:async t=>{let e="",a=0,r=0;const o=new Image;o.setAttribute("crossorigin","crossorigin"),o.src=t;const n=await new Promise(((t,e)=>{o.onload=()=>{a=o.width,r=o.height;const e=document.createElement("canvas");e.width=a,e.height=r;const n=e.getContext("2d");if(!n)throw p.NoSupportCanvas();{n.drawImage(o,0,0);const e=n.getImageData(0,0,a,r);t(e)}},o.onerror=()=>{e(p.ImageNotFound())}})),{data:s}=n;for(let c=0;c<s.length;c++)if(c%4==0)s[c]%2==0?s[c]=0:s[c]=255;else{if(c%4==3)continue;s[c]=0}const i=document.createElement("canvas");i.width=a,i.height=r;const d=i.getContext("2d");if(!d)throw p.NoSupportCanvas();return d.putImageData(n,0,0),e=i.toDataURL(),e}});let k=E;const B=a({__name:"pageTextWatermark",setup(t){const e=r(),a=r(),m=()=>{var t;null==(t=a.value)||t.remove()};return o((()=>{a.value=k.page({target:e.value,text:"测试水印",color:"black",fontSize:14,rowGap:30,colGap:30})})),(t,a)=>{const r=n("vir-button");return s(),i(l,null,[d("div",{class:"w-full h-300 bg-slate-200",ref_key:"pageTextRef",ref:e},null,512),c(r,{onClick:m,class:"mt-5"},{default:h((()=>[g("移除水印")])),_:1})],64)}}}),y=""+new URL("../png/wm-661cad7f.png",import.meta.url).href,I=a({__name:"pageImageWatermark",setup(t){const e=r();return o((()=>{k.page({target:e.value,image:y})})),(t,a)=>(s(),i("div",{class:"w-full h-300 bg-slate-200",ref_key:"pageImageRef",ref:e},null,512))}}),C=""+new URL("../png/wm2-6d5d9f0d.png",import.meta.url).href,D=["src"],_=a({__name:"imageTextWatermark",setup(t){const e=r(),a=t=>{e.value=t};return o((()=>{k.image({target:C,text:"测试专用",rowGap:100,color:"black",fontSize:20,success:a})})),(t,a)=>(s(),i("div",null,[d("img",{src:e.value,alt:""},null,8,D)]))}}),A={class:"flex"},N=["src"],W=["src"],S=a({__name:"imageTextWatermark2",setup(t){const e=r(),a=r(),l=r(!1),u=t=>{e.value=t},p=async()=>{if(!e.value)return;const t=await k.utils.decodeImage(e.value);a.value=t,l.value=!1};return o((()=>{k.image({target:C,secret:!0,text:"你看不见我",rowGap:100,color:"black",fontSize:20,success:u})})),(t,r)=>{const o=n("vir-button");return s(),i("div",A,[d("img",{src:e.value,alt:""},null,8,N),c(o,{loading:l.value,onClick:p},{default:h((()=>[g("解密")])),_:1},8,["loading"]),a.value?(s(),i("img",{key:0,src:a.value,alt:""},null,8,W)):m("",!0)])}}}),T={class:"markdown-body"},G=u('<h1 id="watermark-%E6%B0%B4%E5%8D%B0" tabindex="-1">WaterMark 水印</h1><p><code>Canvas</code>水印方案，兼容性好。<br> 【多场景覆盖】：支持向<code>页面元素</code> <code>图片</code>添加<code>文字</code> <code>图片</code> 水印 以及对图片添加<code>文字暗水印及暗水印解密</code><br> 【高安全性】：支持水印守卫，防止篡改删除水印<br> 【高自由度】：水印支持自定义字体颜色、字体大小、间距、层级、旋转角度<br></p><h2 id="%E5%90%91%E9%A1%B5%E9%9D%A2%E5%85%83%E7%B4%A0%E6%B7%BB%E5%8A%A0%E6%96%87%E5%AD%97%E6%B0%B4%E5%8D%B0" tabindex="-1">向页面元素添加文字水印</h2>',3),M=d("h2",{id:"%E5%90%91%E9%A1%B5%E9%9D%A2%E5%85%83%E7%B4%A0%E6%B7%BB%E5%8A%A0%E5%9B%BE%E7%89%87%E6%B0%B4%E5%8D%B0",tabindex:"-1"},"向页面元素添加图片水印",-1),z=d("blockquote",null,[d("p",null,[g("Tip"),d("br"),g(" 注意：由于图片水印通过"),d("code",null,"background-image"),g("注入"),d("code",null,"canvas"),g("，故此模式下无法进行设置水印间的间距")])],-1),L=d("h2",{id:"%E5%90%91%E5%9B%BE%E7%89%87%E6%B7%BB%E5%8A%A0%E6%96%87%E5%AD%97%E6%B0%B4%E5%8D%B0",tabindex:"-1"},"向图片添加文字水印",-1),P=d("h2",{id:"%E5%90%91%E5%9B%BE%E7%89%87%E6%B7%BB%E5%8A%A0%E6%96%87%E5%AD%97%E6%9A%97%E6%B0%B4%E5%8D%B0",tabindex:"-1"},"向图片添加文字暗水印",-1),R=u('<h2 id="watermark.page-%E5%B1%9E%E6%80%A7" tabindex="-1">WaterMark.page 属性</h2><table><thead><tr><th>属性</th><th>说明</th><th>类型</th><th>可选值</th><th>默认值</th></tr></thead><tbody><tr><td>target</td><td>目标元素</td><td>HTMLElement</td><td>—</td><td>document.body</td></tr><tr><td>text</td><td>水印文字内容(text or image choose one)</td><td>string</td><td>—</td><td>VirWaterMark</td></tr><tr><td>image</td><td>水印图片地址(text or image choose one)</td><td>string</td><td>auto、visible</td><td>—</td></tr><tr><td>color</td><td>水印文字颜色</td><td>array</td><td>—</td><td>rgba(0, 0, 0, 0.15)</td></tr><tr><td>fontSize</td><td>水印文字大小</td><td>number</td><td>—</td><td>24</td></tr><tr><td>zIndex</td><td>水印层级</td><td>number</td><td>—</td><td>10000</td></tr><tr><td>rowGap</td><td>水印横向间距（仅 text）</td><td>number</td><td>—</td><td>0</td></tr><tr><td>colGap</td><td>水印纵向间距 （仅 text）</td><td>number</td><td>—</td><td>0</td></tr></tbody></table><h2 id="watermark.image-%E5%B1%9E%E6%80%A7" tabindex="-1">WaterMark.image 属性</h2><table><thead><tr><th>属性</th><th>说明</th><th>类型</th><th>可选值</th><th>默认值</th></tr></thead><tbody><tr><td>target</td><td>目标元素</td><td>HTMLElement</td><td>—</td><td>document.body</td></tr><tr><td>text</td><td>水印文字内容(text or image choose one)</td><td>string</td><td>—</td><td>VirWaterMark</td></tr><tr><td>image</td><td>水印图片地址(text or image choose one)</td><td>string</td><td>auto、visible</td><td>—</td></tr><tr><td>imageWidth</td><td>水印图片宽度 （仅 text）</td><td>number</td><td>—</td><td>—</td></tr><tr><td>imageHeight</td><td>水印图片高度 （仅 text）</td><td>number</td><td>—</td><td>—</td></tr><tr><td>color</td><td>水印文字颜色</td><td>array</td><td>—</td><td>rgba(0, 0, 0, 0.15)</td></tr><tr><td>fontSize</td><td>水印文字大小</td><td>number</td><td>—</td><td>24</td></tr><tr><td>secret</td><td>开启暗水印</td><td>boolean</td><td>—</td><td>false</td></tr><tr><td>position</td><td>水印位置</td><td>number</td><td>repeat、center、bottomRight、bottomLeft、topLeft、topRight</td><td>repeat</td></tr></tbody></table><h2 id="watermark.utils-%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0" tabindex="-1">WaterMark.utils 内置函数</h2><table><thead><tr><th>函数名</th><th>说明</th><th>参数</th></tr></thead><tbody><tr><td>decodeImage</td><td>暗水印解密，返回 <code>Promise&lt;string&gt;</code></td><td><code>url&lt;string&gt;</code></td></tr></tbody></table><h2 id="watermark-%E4%BA%8B%E4%BB%B6" tabindex="-1">WaterMark 事件</h2><table><thead><tr><th>事件名</th><th>说明</th><th>参数</th></tr></thead><tbody><tr><td>remove</td><td>清除水印</td><td>—</td></tr></tbody></table>',8),H={__name:"README",setup:(t,{expose:e})=>(e({frontmatter:{}}),(t,e)=>{const a=n("show-code");return s(),i("div",T,[G,c(a,{showPath:"watermark/components/pageTextWatermark"},{default:h((()=>[c(B)])),_:1}),M,z,c(a,{showPath:"watermark/components/pageImageWatermark"},{default:h((()=>[c(I)])),_:1}),L,c(a,{showPath:"watermark/components/imageTextWatermark"},{default:h((()=>[c(_)])),_:1}),P,c(a,{showPath:"watermark/components/imageTextWatermark2"},{default:h((()=>[c(S)])),_:1}),R])})};export{H as default};
